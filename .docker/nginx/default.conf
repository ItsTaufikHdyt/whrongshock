server {
  listen 80;
  # SERVER_NAME di-pass via env (compose) -> gunakan default "_" bila kosong
  server_name ${SERVER_NAME};

  root /var/www/public;
  index index.php index.html;

  # Upload besar
  client_max_body_size 100M;

  # Laravel front controller
  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }

  # PHP-FPM
  location ~ \.php$ {
    try_files $uri =404;
    include /etc/nginx/fastcgi.conf;                 # SCRIPT_FILENAME dll
    fastcgi_pass app:9000;
    fastcgi_read_timeout 3600;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
  }

  # Cache file statik
  location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|webp|woff2?)$ {
    access_log off;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    try_files $uri =404;
  }

  # Lindungi file tersembunyi
  location ~ /\.(?!well-known) {
    deny all;
  }

  # Jangan eksekusi PHP di luar public
  location ~* /(?:storage|vendor|resources|\.env) {
    deny all;
  }

  # (Opsional) Gzip
  gzip on;
  gzip_comp_level 5;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss application/xml application/vnd.ms-fontobject font/ttf font/otf image/svg+xml;

  # (Opsional) Header keamanan
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header X-XSS-Protection "1; mode=block" always;
}
